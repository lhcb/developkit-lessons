
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>New counters Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="The Starterkit team and contributors">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-panels/panels.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-katex-auto-render/katex.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-term/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="05-cpp.html" />
    
    
    <link rel="prev" href="03b-upgrading.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    The LHCb Starterkit
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../CONTRIBUTING.html">
            
                <a href="../CONTRIBUTING.html">
            
                    
                    Contributing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" >
            
                <a target="_blank" href="https://lhcb.github.io/starterkit-lessons/first-analysis-steps/">
            
                    
                    First analysis steps
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" >
            
                <a target="_blank" href="https://lhcb.github.io/starterkit-lessons/second-analysis-steps/">
            
                    
                    Second analysis steps
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" >
            
                <a target="_blank" href="https://lhcb.github.io/analysis-essentials/">
            
                    
                    First computing steps
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="./">
            
                <a href="./">
            
                    
                    First development steps
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1" data-path="01-intro.html">
            
                <a href="01-intro.html">
            
                    
                    Setting up a development environment
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.1.1" data-path="01a-cernvm.html">
            
                <a href="01a-cernvm.html">
            
                    
                    Setting up a CernVM
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.1.2" data-path="01b-docker.html">
            
                <a href="01b-docker.html">
            
                    
                    Setting up with Docker
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.1.3" data-path="01c-centos.html">
            
                <a href="01c-centos.html">
            
                    
                    Setting up CentOS 7
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.1.2" data-path="01-git.html">
            
                <a href="01-git.html">
            
                    
                    Git for LHCb
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.2.1" data-path="01d-setupsimple.html">
            
                <a href="01d-setupsimple.html">
            
                    
                    LB git
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.2.2" data-path="01e-setupcomplete.html">
            
                <a href="01e-setupcomplete.html">
            
                    
                    Pure git
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.1.3" data-path="01f-building.html">
            
                <a href="01f-building.html">
            
                    
                    Building LHCb software
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.4" data-path="01g-testing.html">
            
                <a href="01g-testing.html">
            
                    
                    Testing and examples in LHCb
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.5" data-path="02a-gaudi-helloworld.html">
            
                <a href="02a-gaudi-helloworld.html">
            
                    
                    Hello World in the Gaudi Framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.6" data-path="02b-gaudi-intro.html">
            
                <a href="02b-gaudi-intro.html">
            
                    
                    Intro to the Gaudi Framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.7" data-path="03a-gaudi.html">
            
                <a href="03a-gaudi.html">
            
                    
                    The Gaudi Framework
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.8" data-path="03b-upgrading.html">
            
                <a href="03b-upgrading.html">
            
                    
                    Upgrading algorithms
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="5.1.9" data-path="03c-counters.html">
            
                <a href="03c-counters.html">
            
                    
                    New counters
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.10" data-path="05-cpp.html">
            
                <a href="05-cpp.html">
            
                    
                    What's new in C++
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="5.1.10.1" data-path="05a-cpp11.html">
            
                <a href="05a-cpp11.html">
            
                    
                    What's new in C++11
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.10.2" data-path="05b-cpp14.html">
            
                <a href="05b-cpp14.html">
            
                    
                    What's new in C++14
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.10.3" data-path="05c-cpp17.html">
            
                <a href="05c-cpp17.html">
            
                    
                    What's new in C++17
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.10.4" data-path="05d-cppfuture.html">
            
                <a href="05d-cppfuture.html">
            
                    
                    Prospects in C++'s future
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="5.1.11" data-path="06a-perf.html">
            
                <a href="06a-perf.html">
            
                    
                    C++ performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="5.1.12" data-path="06b-python.html">
            
                <a href="06b-python.html">
            
                    
                    Python in the upgrade era
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="6.1" >
            
                <a target="_blank" href="ref://developkit-lessons.pdf">
            
                    
                    Download PDF
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >New counters</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="new-counters">New Counters</h1>
<p><div class="panel panel-warning"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(7917270972);" id="learning-objectives"><i class="fa fa-line-chart"></i> Learning Objectives<span id="heading-7917270972"></span></h3></div><div class="panel-body" id="panel-7917270972"><ul>
<li>&quot;Learn about upgrading to the new counters in Gaudi</li>
</ul>
</div></div></p>
<h2 id="old-counters">Old counters</h2>
<p>The old counters looked like this:</p>
<pre><code class="lang-cpp">++counter(<span class="hljs-string">&quot;# valid banks&quot;</span>); <span class="hljs-comment">// Add one</span>
counter(<span class="hljs-string">&quot;skipped Banks&quot;</span>) += tBanks.size(); <span class="hljs-comment">// Add a number</span>
++counter(<span class="hljs-string">&quot;nInAcceptance&quot;</span>); <span class="hljs-comment">// binomial here !</span>
</code></pre>
<p>This approach as a plethora of issues. First, counters are looked up by string. If one does not exist with that string, a new one is created.
There are special name patterns that indicate different sorts of counters, such as &quot;acc&quot; for binomial. This is all protected by a mutex, which locks on every counter access.
And there are five doubles that are tracked for all counters, such as the mean, even if all you need is a simple increment counter.</p>
<p>All together, this meant that 33% of the time in <code>createUTLiteCluster</code> was spent on counters alone!</p>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(7853811275);" id="half-way-thereclick-to-expand"><i class="fa fa-bell"></i> Half way there<span id="heading-7853811275">Click to expand</span></h3></div><div class="panel-body" style="display: none" id="panel-7853811275"><p>This removes the name lookup, but still is not ideal, either for timing or design:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">class</span> ... {
    <span class="hljs-keyword">mutable</span> StatEntity m_validBanks{<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;# valid banks&quot;</span>};
};
</code></pre>
</div></div></p>
<h2 id="new-counters">New counters</h2>
<p>To replace this system, a new counter object was built in Gaudi. Usage looks like this:</p>
<pre><code class="lang-cpp"><span class="hljs-keyword">class</span> ... {
    <span class="hljs-keyword">mutable</span> Counter&lt;&gt; m_validBanks{<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;# valid banks&quot;</span>};
};
</code></pre>
<p>This is allowed to be mutable, since it locks internally (just like an atomic or mutex member of a class can be mutable). The string here is only used for
print out purposes. And there is a family of counters, depending on what you want:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Usage details</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Counter</code></td>
<td>A pure counter, counts number of entries (<code>++</code> only).</td>
</tr>
<tr>
<td><code>AveragingCounter</code></td>
<td>Keeps count and sum, can compute mean. (<code>+=</code> also)</td>
</tr>
<tr>
<td><code>SigmaCounter</code></td>
<td>Also keeps sum of squares, can compute variance, standard deviation.</td>
</tr>
<tr>
<td><code>StatCounter</code></td>
<td>Also keeps min/max values.</td>
</tr>
<tr>
<td><code>BinomialCounter</code></td>
<td>Dedicated to binomial law, compute efficiency.</td>
</tr>
</tbody>
</table>
<p>There are also two template parameters, with the following defaults:</p>
<pre><code class="lang-cpp">Counter&lt;<span class="hljs-keyword">double</span>, atomicity::atomic&gt;
</code></pre>
<p>The first template parameter is the type (float is usually fine), and the second is the atomicity,
with <code>atomic</code> and <code>none</code> (non-atomic operations, for local counters). If you use <code>atomicity::none</code>,
the member should not be marked <code>mutable</code>!</p>
<h2 id="temporary-counters">Temporary counters</h2>
<p>This helped improve the speed, partially by using atomics instead of mutex locks, and partially by reducing the number of operations when
not needed. But the biggest improvement came from buffered local counters. If you create a buffer counter from a counter, you can update it
locally, and then when the object goes out of scope, the counter it was created from updates. You can now do this:</p>
<pre><code class="lang-cpp">AveragingCounter&lt;<span class="hljs-keyword">float</span>&gt; counter{<span class="hljs-keyword">this</span>, <span class="hljs-string">&quot;main counter&quot;</span>};
{ <span class="hljs-comment">// Entering a local scope</span>
    <span class="hljs-keyword">auto</span> buf = counter.buffer();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++)
        buf += i; <span class="hljs-comment">// No atomics here, pure local!</span>
} <span class="hljs-comment">// single atomic update of main counter</span>
</code></pre>
<p>This allows you to loop over tracks, or some other per-event structure, and still only update your counters once per event (which is much, much faster). This removed
the rest of the measurable time spent in counters in <code>createUTLiteCluster</code>, giving a 33% speed up!</p>
<p><div class="panel panel-success"><div class="panel-heading"><h3 class="panel-title" onclick="javascript:toggle(2803941094);" id="design-for-expertsclick-to-expand"><i class="fa fa-bell"></i> Design for experts<span id="heading-2803941094">Click to expand</span></h3></div><div class="panel-body" style="display: none" id="panel-2803941094"><ul>
<li>Counters are only accumulators + printing</li>
<li>Many basic accumulator exists<ul>
<li>count, sum, square, min, max, true, false</li>
</ul>
</li>
<li>You can easily extend the set, based on <code>GenericAccumulator</code> class<ul>
<li>Templated by type, atomicity, transform (identify, square), <code>ValueHandler</code> (sum, maximum, ...)</li>
</ul>
</li>
<li>They are then merged using <code>AccumulatorSet</code></li>
</ul>
<pre><code class="lang-cpp"><span class="hljs-keyword">struct</span> AveragingAccumulator :
    AccumulatorSet&lt;Arithmetic, Atomicity, CountAccumulator, SumAccumulator&gt;
</code></pre>
</div></div></p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="03b-upgrading.html" class="navigation navigation-prev " aria-label="Previous page: Upgrading algorithms">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="05-cpp.html" class="navigation navigation-next " aria-label="Next page: What's new in C++">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"New counters","level":"5.1.9","depth":2,"next":{"title":"What's new in C++","level":"5.1.10","depth":2,"path":"first-development-steps/05-cpp.md","ref":"first-development-steps/05-cpp.md","articles":[{"title":"What's new in C++11","level":"5.1.10.1","depth":3,"path":"first-development-steps/05a-cpp11.md","ref":"first-development-steps/05a-cpp11.md","articles":[]},{"title":"What's new in C++14","level":"5.1.10.2","depth":3,"path":"first-development-steps/05b-cpp14.md","ref":"first-development-steps/05b-cpp14.md","articles":[]},{"title":"What's new in C++17","level":"5.1.10.3","depth":3,"path":"first-development-steps/05c-cpp17.md","ref":"first-development-steps/05c-cpp17.md","articles":[]},{"title":"Prospects in C++'s future","level":"5.1.10.4","depth":3,"path":"first-development-steps/05d-cppfuture.md","ref":"first-development-steps/05d-cppfuture.md","articles":[]}]},"previous":{"title":"Upgrading algorithms","level":"5.1.8","depth":2,"path":"first-development-steps/03b-upgrading.md","ref":"first-development-steps/03b-upgrading.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","panels@git+https://github.com/lhcb/gitbook-plugin-panels.git#master","katex-auto-render@git+https://github.com/lhcb/gitbook-plugin-katex-auto-render.git#master","collapsible-menu","otherlink","term"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"collapsible-menu":{},"search":{},"otherlink":{},"term":{"copyButtons":true,"fade":true,"lineStyles":true,"prompt":"(?<prompt>[^\\$^#^:]*)(?<pathsep>:?)(?<path>[^\\$^#]*?)(?<delimiter>[\\$#] )(?<command>.*)$","style":"default"},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"panels":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"katex-auto-render":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"The Starterkit team and contributors","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"first-development-steps/03c-counters.md","mtime":"2018-06-29T09:42:15.744Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2018-06-29T09:43:38.697Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-panels/panels.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/katex.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/auto-render.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-katex-auto-render/enable-auto-render.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-otherlink/js/otherlink.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-term/clipboard.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-term/initclip.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-term/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

